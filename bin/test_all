#! /usr/bin/env node

var db = require('../lib/db')
var testModule = require('../lib/test_module')
var iterate = require('../lib/mongo/iterate_cursor')
var upsert = require('../lib/mongo/upsert')
var findOne = require('../lib/mongo/find_only_one')
var log = require('npmlog')
var cmdLn = require('cmd-ln')
var assert = require('assert')
var is = require('is-type')

cmdLn(function(_number){
  var dir = '/tmp/browserify-search'

  db(function(err, db){
    if (err) return log.error(err.message)

    var modules = db.collection('modules')

    var version = 4

    var criteria = {
      $or: [
        {'testResults.version': {$lt: version}}, 
        {'testResults.version': null}
      ]
    }

    var cursor = modules
      .find(
        criteria,
        {name: true})

    if (_number){
      var num = Number(_number)
      assert(is.number(num))
      assert(Math.floor(num) === num)
      cursor = cursor.limit(num)
    }

    iterate(cursor, 
      function(module, next){
        testModule(module.name, dir, function(err, results){
          if (err){
            // this shouldn't happen
            log.error(module.name + ':', err.message)
            return next(err)
          }
          displayResults(module, results)
          findOne(modules, {name: module.name}, function(err, mdoc){
            if (err){
              log.error(module.name + ':', err.message)
              return next(err)
            }
            mdoc.testResults = results;
            mdoc.testResults.version = version
            mdoc.browserify = results.install.passed && 
              results.browserify.passed;
            upsert(modules, 'name', mdoc, function(err){
              if (err) return next(err)
              next()
            })
          })
        })
      }, function(err){
        if (err) console.error(err.message)
        log.info('ok')
        db.close()
      })
  })

})

function displayResults(module, results){
  var passed = 
    results.install.passed &&
    results.browserify.bundle.passed &&
    results.browserify.test.passed
  if (passed){
    log.info(module.name + ':', 'worked', results)
  }else{
    log.error(module.name + ':', 
      'failed', 
      results)
  }
}