#! /usr/bin/env node

var cmdLn = require('cmd-ln')
var db = require('../lib/db')
var mongoJob = require('mongo_job')
var iterate = require('../lib/mongo/iterate_cursor')
var log = require('npmlog')

cmdLn(function(module_or_count){
  db(function(err, db){
    var jobs = db.collection('jobs')
    
    if (isNaN(module_or_count)){
      mongoJob.dispatch(jobs, module, function(err){
        if (err) console.error(err.message)
        else console.log('ok')
        db.close()
      })
    }else{
      var number = Number(module_or_count)
      dispatchModules(number, db, function(err){
        if (err) console.error(err.message)
        else console.log('ok')
        db.close()
      })
    }
  })
})

function dispatchModules(count, db, callback){
  var modules = db.collection('modules')
  var jobs = db.collection('jobs')
  var version = 4

  var criteria = {
    $or: [
      {'testResults.version': {$lt: version}}, 
      {'testResults.version': null}
    ]
  }

  criteria = {'testResults.install.passed': false}

  var cursor = modules
    .find(
      criteria,
      {name: true})
    .limit(count)

  iterate(cursor, 
    function(modDoc, next){
      var module = modDoc.name
      log.info('Dispatching ' + module)
      mongoJob.dispatch(jobs, module, next)
    },
    callback
  )

}