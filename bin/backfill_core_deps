#! /usr/bin/env node

var db = require('../lib/db')
var testModule = require('../lib/test_module')
var dir = '/tmp/browserify-search'
var eachLimit = require('../lib/mongo/each_limit')

db(function(err, db){
  if (err) return console.error(err.message)
  var Modules = db.collection('modules')

  var cursor = Modules.find(
    {'testResults.browserify.test.passed': false}, 
    {name: true})

  eachLimit(cursor, 4, 
    function(doc, next){    
      testModule(doc.name, dir, function(err, results){
        if (err) return console.error(err.message)
        console.log('Got results for', doc.name)
        Modules.update(
          {name: doc.name},
          {$set: {testResults: results}},
          next)
      })
    },
    function(err){
      if (err) return console.error(err.message)
      db.close()
    })
})